name: Build Flatpaks

on:
  workflow_dispatch:

jobs:
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from meson.build
        id: get_version
        run: |
          VERSION=$(grep -Po "version:\s*['\"]\K[^'\"]+" meson.build | head -n1)
          if [ -z "$VERSION" ]; then
            echo "ERROR: could not find version in meson.build" >&2
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build-flatpak:
    name: Build Flatpak (matrix)
    needs: get-version
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: "x64"
            flatpak_arch: "x86_64"
            runner: "ubuntu-24.04"
          - arch: "arm64"
            flatpak_arch: "aarch64"
            runner: "ubuntu-24.04-arm"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Flatpak dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder git

          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install --arch=${{ matrix.flatpak_arch }} --noninteractive flathub org.gnome.Sdk//49 org.gnome.Platform//49

      - name: Build Flatpak Bundle
        run: |
          echo "Building Flatpak for ${{ matrix.flatpak_arch }}"
          git clone https://github.com/flathub/shared-modules.git build-aux/flatpak/shared-modules
          flatpak-builder --force-clean --repo=repo build-dir build-aux/flatpak/io.github.redddfoxxyy.samaya.json
          OUT=samaya-v${{ needs.get-version.outputs.version }}-${{ matrix.flatpak_arch }}.flatpak
          flatpak build-bundle repo "$OUT" io.github.redddfoxxyy.samaya
          echo "Built $OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: samaya-${{ needs.get-version.outputs.version }}-${{ matrix.flatpak_arch }}
          path: samaya-v${{ needs.get-version.outputs.version }}-${{ matrix.flatpak_arch }}.flatpak

  release-upload:
    name: Create Release & Upload Flatpaks (arm64 runner)
    needs: build-flatpak
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout (for action compatibility)
        uses: actions/checkout@v4

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: samaya-${{ needs.get-version.outputs.version }}-x86_64
          path: ./artifacts

      - name: Download aarch64 artifact
        uses: actions/download-artifact@v4
        with:
          name: samaya-${{ needs.get-version.outputs.version }}-aarch64
          path: ./artifacts

      - name: List downloaded artifacts
        run: ls -la ./artifacts

      - name: Create Latest Release and attach artifacts
        uses: softprops/action-gh-release@v2
        with:
          name: "Samaya v${{ needs.get-version.outputs.version }}"
          draft: false
          prerelease: false
          make_latest: true
          tag_name: ${{ needs.get-version.outputs.version }}
          files: ./artifacts/*.flatpak
          body: |
            ## Samaya Release Binaries for v${{ needs.get-version.outputs.version }}:
